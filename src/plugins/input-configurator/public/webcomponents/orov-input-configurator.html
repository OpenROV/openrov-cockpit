<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../orov-behaviors/orov-behavior.html">
<link rel="import" href="../paper-item/paper-item.html">">
<link rel="import" href="../paper-listbox/paper-listbox.html">">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">

<dom-module name="orov-input-configurator">

    <style type="text/css">
        .successfullySaved {
            opacity: 1;
        }
        
        .successfullySaved.hide {
            opacity: 0;
            display: block;
            transition: opacity 1.5s ease-out;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
        }

        td, th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }

        tr:nth-child(even) {
            background-color: #dddddd;
        }
        
        #tableContainer {
            overflow: auto;
            height: 400px;
        }
        
        section {
            position: relative;
            border: 1px solid #000;
        }

        #stickyHeader {
            background-color: white;
        }

        paper-button {
            margin-top: 2em;
        }

        paper-tab {
            background-color:#0D47A1;
        }
        /**
        * KEYS.css
        *
        * A simple stylesheet for rendering beautiful keyboard-style elements.
        *
        * Author:  Michael HÃ¼neburg
        * Website: http://michaelhue.com/keyscss
        * License: MIT License (see LICENSE.txt)
        */

        /* Base style, essential for every key. */
        kbd, .key {
            display: inline;
            display: inline-block;
            min-width: 1em;
            padding: .2em .3em;
            font: normal .85em/1 "Lucida Grande", Lucida, Arial, sans-serif;
            text-align: center;
            text-decoration: none;
            -moz-border-radius: .3em;
            -webkit-border-radius: .3em;
            border-radius: .3em;
            border: none;
            cursor: default;
            -moz-user-select: none;
            -webkit-user-select: none;
            user-select: none;
        }
        kbd[title], .key[title] {
            cursor: help;
        }

        /* Dark style for display on light background. This is the default style. */
        kbd, kbd.dark, .dark-keys kbd, .key, .key.dark, .dark-keys .key {
            background: rgb(80, 80, 80);
            background: -moz-linear-gradient(top, rgb(60, 60, 60), rgb(80, 80, 80));
            background: -webkit-gradient(linear, left top, left bottom, from(rgb(60, 60, 60)), to(rgb(80, 80, 80)));
            color: rgb(250, 250, 250);
            text-shadow: -1px -1px 0 rgb(70, 70, 70);
            -moz-box-shadow: inset 0 0 1px rgb(150, 150, 150), inset 0 -.05em .4em rgb(80, 80, 80), 0 .1em 0 rgb(30, 30, 30), 0 .1em .1em rgba(0, 0, 0, .3);
            -webkit-box-shadow: inset 0 0 1px rgb(150, 150, 150), inset 0 -.05em .4em rgb(80, 80, 80), 0 .1em 0 rgb(30, 30, 30), 0 .1em .1em rgba(0, 0, 0, .3);
            box-shadow: inset 0 0 1px rgb(150, 150, 150), inset 0 -.05em .4em rgb(80, 80, 80), 0 .1em 0 rgb(30, 30, 30), 0 .1em .1em rgba(0, 0, 0, .3);
        }

        /* Light style for display on dark background. */
        kbd.light, .light-keys kbd, .key.light, .light-keys .key {
            background: rgb(250, 250, 250);
            background: -moz-linear-gradient(top, rgb(210, 210, 210), rgb(255, 255, 255));
            background: -webkit-gradient(linear, left top, left bottom, from(rgb(210, 210, 210)), to(rgb(255, 255, 255)));
            color:  rgb(50, 50, 50);
            text-shadow: 0 0 2px rgb(255, 255, 255);
            -moz-box-shadow: inset 0 0 1px rgb(255, 255, 255), inset 0 0 .4em rgb(200, 200, 200), 0 .1em 0 rgb(130, 130, 130), 0 .11em 0 rgba(0, 0, 0, .4), 0 .1em .11em rgba(0, 0, 0, .9);
            -webkit-box-shadow: inset 0 0 1px rgb(255, 255, 255), inset 0 0 .4em rgb(200, 200, 200), 0 .1em 0 rgb(130, 130, 130), 0 .11em 0 rgba(0, 0, 0, .4), 0 .1em .11em rgba(0, 0, 0, .9);
            box-shadow: inset 0 0 1px rgb(255, 255, 255), inset 0 0 .4em rgb(200, 200, 200), 0 .1em 0 rgb(130, 130, 130), 0 .11em 0 rgba(0, 0, 0, .4), 0 .1em .11em rgba(0, 0, 0, .9);
        }        
    </style>

    <template>

        <!-- TODO: Properly implement language formatting -->
        <h2>Input Configurator: BETA</h2>

        <p>
            To change a control mapping, click on the control
        </p>        
        <section class="">      
            <div id="tableContainer">
                <table>
                    <thead id="stickyHeader">
                        <tr>
                            <th>
                                <div>{{__('Command')}}</div>
                            </th>
                            <th>
                                <div>{{__('Keyboard')}}</div>
                            </th>
                            <th>
                                <div>{{__('Gamepad')}}</div>
                            </th>
                            <th>
                                <div>{{__('Description')}}</div>
                            </th>            
                        </tr>
                    </thead>
                    <tbody>
                        <template is="dom-repeat" items="{{_presetToArray(preset)}}">
                            <tr>
                                <td>{{__(item.name)}}</td>
                                <td><kbd class="light" on-tap="_handleKeyboardChange">{{item.bindings.keyboard}}&nbsp;</kbd></td>
                                <td><kbd on-tap="_handleGamepadChange">{{item.bindings.gamepad}}&nbsp;</kbd></td>
                                <td>{{__(item.description)}}</td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </section>

        <paper-button raised on-click="updatePreset">Update Preset</paper-button>
        <paper-toast id="updatePresetToast" text="Updated Preset!"></paper-toast>

    </template>
    
    <script src="MouseTrapExtension.js"></script>
    <script>
        
        (function() {

            var keyboardMap = ["", "", "", "CANCEL", "", "", "HELP", "", "BACK_SPACE", "TAB", "", "", "CLEAR", "ENTER", "RETURN", "", "SHIFT", "CTRL", "ALT", "PAUSE", "CAPSLOCK", "KANA", "EISU", "JUNJA", "FINAL", "HANJA", "", "ESC", "CONVERT", "NONCONVERT", "ACCEPT", "MODECHANGE", "SPACE", "PAGE_UP", "PAGE_DOWN", "END", "HOME", "LEFT", "UP", "RIGHT", "DOWN", "SELECT", "PRINT", "EXECUTE", "PRINTSCREEN", "INSERT", "DELETE", "", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9", ":", ";", "LESS_THAN", "=", "GREATER_THAN", "QUESTION_MARK", "AT", "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z", "WIN", "", "CONTEXT_MENU", "", "SLEEP", "NUMPAD0", "NUMPAD1", "NUMPAD2", "NUMPAD3", "NUMPAD4", "NUMPAD5", "NUMPAD6", "NUMPAD7", "NUMPAD8", "NUMPAD9", "MULTIPLY", "ADD", "SEPARATOR", "SUBTRACT", "DECIMAL", "DIVIDE", "F1", "F2", "F3", "F4", "F5", "F6", "F7", "F8", "F9", "F10", "F11", "F12", "F13", "F14", "F15", "F16", "F17", "F18", "F19", "F20", "F21", "F22", "F23", "F24", "", "", "", "", "", "", "", "", "NUM_LOCK", "SCROLL_LOCK", "WIN_OEM_FJ_JISHO", "WIN_OEM_FJ_MASSHOU", "WIN_OEM_FJ_TOUROKU", "WIN_OEM_FJ_LOYA", "WIN_OEM_FJ_ROYA", "", "", "", "", "", "", "", "", "", "CIRCUMFLEX", "EXCLAMATION", "\"", "#", "$", "%", "&", "_", "(", ")", "*", "+", "|", "HYPHEN_MINUS", "{", "}", "~", "", "", "", "", "VOLUME_MUTE", "VOLUME_DOWN", "VOLUME_UP", "", "", ";", "=", ",", "-", ".", "/", "`", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "[", "\\", "]", "'", "", "META", "ALTGR", "", "WIN_ICO_HELP", "WIN_ICO_00", "", "WIN_ICO_CLEAR", "", "", "WIN_OEM_RESET", "WIN_OEM_JUMP", "WIN_OEM_PA1", "WIN_OEM_PA2", "WIN_OEM_PA3", "WIN_OEM_WSCTRL", "WIN_OEM_CUSEL", "WIN_OEM_ATTN", "WIN_OEM_FINISH", "WIN_OEM_COPY", "WIN_OEM_AUTO", "WIN_OEM_ENLW", "WIN_OEM_BACKTAB", "ATTN", "CRSEL", "EXSEL", "EREOF", "PLAY", "ZOOM", "", "PA1", "WIN_OEM_CLEAR", ""];

            Polymer({
                is: "orov-input-configurator",
                properties: {
                    preset: {
                        type: Map
                    }
                },

                behaviors: [namespace('behaviors').oROVStandard],
                listeners:
                {
                    'tableContainer.scroll': 'tableContainerScroll'
                },

                registerEmitterHandlers: function(emitter) {
                    var self = this;
                    this.presetFunction = function(preset) {
                        console.log("Got a preset:", preset);

                        //Set this to our current preset on the input Configurator
                        self.preset = preset;

                        //Update the UI to reflect this
                        self._presetToArray(self.preset);
                    }.bind(this);

                    emitter.on('plugin.inputController.updatedPreset', this.presetFunction );
                },
                detached: function(){
                    this.eventEmitter.off('plugin.inputController.updatedPreset',this.presetFunction)
                },
                attached: function() {
                    var self = this;

                    //Tell the input controller we want presets with a recurrent function 
                    if(self.presets == undefined)
                    {
                        self.eventEmitter.emit('plugin.inputController.sendPreset');
                    }
                    
                },
                inputsChanged: function(inputs)
                {
                    this.inputs = inputs;
                },
                openUpdatePresetToast: function() {
                    this.$.updatePresetToast.open();
                },

                tableContainerScroll: function() {
                    var self = this;

                    /*CSS way to do sticky headers*/
                    var translate = "translate(0," + self.$.tableContainer.scrollTop + "px)";
                    self.$.stickyHeader.style.transform = translate;
                },

                updatePreset: function() {
                    var self = this;
                    //Actually update the preset with the input controller
                    console.log("Updating the preset with input controller");
                    
                    //If sucessful, open up the toast
                    this.openUpdatePresetToast();
                },

                _presetToArray: function(preset) {
                    //Converts a js Map object to an array
                    var arrayPreset = [];

                    //Iterate through the preset MAP to create an array for the dom element
                    preset.inputs.forEach( function(value, input) {
                        
                        var binding = {
                            keyboard: undefined,
                            gamepad: undefined
                        };
                        
                        //Register Keyboard control bindings
                        var keyboardBinding = value.bindings.find( function(binding) {
                            return binding.controller == "keyboard";
                        });
                        if(keyboardBinding !== undefined)
                        {
                            binding.keyboard = keyboardBinding.input;
                        }

                        //Register Gamepad control bindings
                        var gamepadBinding = value.bindings.find( function(binding) {
                            return binding.controller == "gamepad";
                        });
                        if(gamepadBinding !== undefined)
                        {
                            binding.gamepad = gamepadBinding.input;
                        }

                        var arrayInput = {
                            name: value.name,
                            description: value.description,
                            bindings: binding
                        };
                        arrayPreset.push(arrayInput);
                    });
                    return arrayPreset;
                }
            })
        })();
    </script>

</dom-module>