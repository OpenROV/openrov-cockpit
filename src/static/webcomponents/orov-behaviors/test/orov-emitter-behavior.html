<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <link rel="import" href="../../polymer/polymer.html">
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import" href="../orov-emitter-behavior.html">
  <link rel="import" href="../testelement.html">
  <script src="../../eventemitter2/lib/eventemitter2.js"></script>
  <script src="../utilities.js"></script>
</head>
<body>
  <test-fixture id="test-element-fixture">
     <template id='t'>
       <test-element id="test-element"></test-element>
     </template>
   </test-fixture>

  <script>
    suite('orov-emitter-behavior', function() {
      var myEl;
      setup(function() {
        myEl = fixture('test-element-fixture');
      });
      test('can get handle to dynamic test element', function() {
        assert.isNotNull(myEl);
        assert.equal(document.getElementById('test-element'),myEl);
      });
      test('behavior is in scope',function(){
        var behaviors = namespace('behaviors');
        assert.isDefined(behaviors.oROVStandardImpl);
      });
      test('build in test listener is registered in _emitterRegistrations',function(){
        assert.isOk(myEl._emitterRegistrations.length,1);
      });
      test('behavior calls registerEmitterHanlders on the element',function(){
        assert.isOk(myEl._registerEmitterHandlersCalled);
      });
      test('the event emitter can be accessed',function(){
        assert.isDefined(myEl.eventEmitter);
      });
      test('Events registered on one event handler automatically register on a new eventEmitter',function(){
        var i = 0;
        var handler = function(){i++;};

        myEl.eventEmitter.on('test',handler);
        //The test element internally registeres 1 event
        //debugger;
        assert.equal(myEl._emitterRegistrations.length,2,'Recorded the event listener');
        var newEmitter = new EventEmitter2();
        myEl.eventEmitter=newEmitter;
        assert.equal(newEmitter.listeners('test')[0],handler,'The new emitter inherits the event handlers from the older emitter');
        assert.equal(newEmitter,myEl.eventEmitter,'The new emitter successfully replaced the old one');
      });
      test('Listening to events using a real eventEmitter works correctly',function(){
        var i = 0;
        var handler = function(){i++;};
        var newEmitter = new EventEmitter2();
        myEl.eventEmitter=newEmitter;
        assert.equal(newEmitter.listeners.length,1,'Adding emitter to new control will only inherit built in listeners');
        myEl.eventEmitter.on('test',handler);
        assert.equal(newEmitter.listeners('test').length,1,'Adding listeners is registered correctly');
        assert.equal(newEmitter.listeners('test-message-1').length,1,'Prior listeners is registered correctly');
        myEl.eventEmitter.emit('test');
        assert.equal(i,1,'Event emitter function call verified')
      });

    });
  </script>
</body>
</html>
