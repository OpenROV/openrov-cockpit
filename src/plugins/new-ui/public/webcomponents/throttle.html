<!--
TODO:  Change the interface for motors to -1/1 with deadzone accounted for to true up the indicators to the actual ranges
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../orov-behaviors/orov-behavior.html">
<dom-module id="orov-newui-throttle">
  <style>
      #container {
        width: 90%;
        height: 110px;
        margin-top: 6px;
        margin-left: 0.9vw;
        margin-bottom: -2.8vw;
      }
      .center {
        left: 0;
        right: 0;
        margin-left: auto;
        margin-right: auto;
        float: none;
      }

      .element svg {
        height: 100px;
        width: 30%;
        float: left;
      }

      #leftThrottleRect {
        fill: #fff9f9;
        fill-opacity: 1;
        stroke: none;

        height: 163;

        /*Hardware acceleration*/
        translate3d(0,0,0);
        transition-duration: 0.10s;
        transformation-timing-function: ease-out;
      }
      #rightThrottleRect {
        fill: #fff9f9;
        fill-opacity: 1;
        stroke: none;

        /*Hardware acceleration*/
        
        translate3d(0,0,0);
        transition-duration: 0.10s;
        transformation-timing-function: ease-out;
      }
      
      #throttle {
        fill: #cccccc;
        fill-opacity: 1;
        stroke: none;

        /*Hardware acceleration*/
        translate3d(0,0,0);
        transition-duration: 0.01s;
      }

    </style>
  <template>
    <div id="container" class="center" style="">

      <div id="template" style="display:none">
      <!--
        viewbox="0 0 106.5676 815.15717"
        -->

      <svg
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:cc="http://creativecommons.org/ns#"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
         xmlns:svg="http://www.w3.org/2000/svg"
         xmlns="http://www.w3.org/2000/svg"
         version="1.1"
         width="106.5676"
         height="815.15717"
         viewbox="0 0 106.5676 815.15717"
         id="svg2">
        <defs
           id="defs4" />
        <metadata
           id="metadata7">
          <rdf:RDF>
            <cc:Work
               rdf:about="">
              <dc:format>image/svg+xml</dc:format>
              <dc:type
                 rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
              <dc:title></dc:title>
            </cc:Work>
          </rdf:RDF>
        </metadata>
        <g
           id="layer1">
          <g
             id="maxThrottle">
            <rect
               width="20.439806"
               height="131.31982"
               x="2.6261578"
               y="341.21436"
               id="leftThrottleRect"
            />
            <rect
               width="20.440001"
               height="131.31982"
               x="84.551224"
               y="341.21436"
               id="rightThrottleRect"
            />
          </g>
          <rect
             width="30.840309"
             height="173.74623"
             x="38.606461"
             y="221.30832"
             id="throttle"
           />
        </g>
        <path
           d="m 1.0500002,407.07541 104.9296498,0"
           id="mid"
           style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
        <g
           id="g3046">
          <g
             transform="translate(0,-38.546504)"
             id="g3018">
            <path
               d="m 2.621677,345.62167 20.362028,0"
               id="mid-7"
               style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
            <path
               d="m 84.621677,345.62167 20.362033,0"
               id="path3016"
               style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
          </g>
          <g
             transform="translate(0,-115.4215)"
             id="g3022">
            <path
               d="m 2.621677,345.62167 20.362028,0"
               id="path3024"
               style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
            <path
               d="m 84.621677,345.62167 20.362033,0"
               id="path3026"
               style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
          </g>
          <g
             transform="translate(0,-192.2965)"
             id="g3028">
            <path
               d="m 2.621677,345.62167 20.362028,0"
               id="path3030"
               style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
            <path
               d="m 84.621677,345.62167 20.362033,0"
               id="path3032"
               style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
          </g>
          <g
             transform="translate(0,-269.1715)"
             id="g3034">
            <path
               d="m 2.621677,345.62167 20.362028,0"
               id="path3036"
               style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
            <path
               d="m 84.621677,345.62167 20.362033,0"
               id="path3038"
               style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
          </g>
          <g
             transform="translate(0,-341.1715)"
             id="g3040">
            <path
               d="m 2.621677,345.62167 20.362028,0"
               id="path3042"
               style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
            <path
               d="m 84.621677,345.62167 20.362033,0"
               id="path3044"
               style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
          </g>
        </g>
        <g
           transform="matrix(-1,0,0,-1,107.60539,816.09046)"
           id="g3063">
          <g
             transform="translate(0,-38.546504)"
             id="g3065">
            <path
               d="m 2.621677,345.62167 20.362028,0"
               id="path3067"
               style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
            <path
               d="m 84.621677,345.62167 20.362033,0"
               id="path3069"
               style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
          </g>
          <g
             transform="translate(0,-115.4215)"
             id="g3071">
            <path
               d="m 2.621677,345.62167 20.362028,0"
               id="path3073"
               style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
            <path
               d="m 84.621677,345.62167 20.362033,0"
               id="path3075"
               style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
          </g>
          <g
             transform="translate(0,-192.2965)"
             id="g3077">
            <path
               d="m 2.621677,345.62167 20.362028,0"
               id="path3079"
               style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
            <path
               d="m 84.621677,345.62167 20.362033,0"
               id="path3081"
               style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
          </g>
          <g
             transform="translate(0,-269.1715)"
             id="g3083">
            <path
               d="m 2.621677,345.62167 20.362028,0"
               id="path3085"
               style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
            <path
               d="m 84.621677,345.62167 20.362033,0"
               id="path3087"
               style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
          </g>
          <g
             transform="translate(0,-341.1715)"
             id="g3089">
            <path
               d="m 2.621677,345.62167 20.362028,0"
               id="path3091"
               style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
            <path
               d="m 84.621677,345.62167 20.362033,0"
               id="path3093"
               style="fill:none;stroke:#ffffff;stroke-width:10;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none" />
          </g>
        </g>
      </svg>


      </div>

      <div id="port" class="element">
      </div>
      <div id="vertical" class="element">
      </div>
      <div id="starboard" class="element">
      </div>

    </div>
  </template>
  <script>
    Number.prototype.map = function (in_min, in_max, out_min, out_max) {
      return (this - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
    };
    function limit(value, l, h) {
      // truncate anything that goes outside of max and min value
      return Math.max(l, Math.min(h, value));
    }
    Polymer({
      is: 'orov-newui-throttle',
      properties: {
        height: {
          type: Number,
          value: function(){return 0;}
        },
        leftThrottleHeight: {
          type: Number,
          value: function(){return 131.31982;}
        },
        maxThrottle: {
          type: Number,
          value: function(){return 100;}
        },
        powerLevel: {
          type: Number,
          value: function(){return 0;}
        }
      },
      behaviors: [namespace('behaviors').oROVStandard],
      registerEmitterHandlers: function(emitter) {
        var self = this;
        emitter.withHistory.on('plugin.rovpilot.setPowerLevel', function (level) {
          if (level !== undefined){
            self.setPowerLevel(level);
          }
        });
        emitter.withHistory.on('plugin.rovpilot.controls', function (data) {
          self.setVertical(Number(data.vertical));
          self.setPort(Number(data.port));
          self.setStarboard(Number(data.starbord));
        });
        emitter.emit('plugin.rovpilot.getState',function(state){
          console.log("Got a state:", state.powerLevel);
          if (state.powerLevel !== undefined){
            self.setPowerLevel(state.powerLevel);
          }
        });
      },
      attached: function () {
        var self = this;
        var template = $(this.$.template).find('svg');
        template.clone().appendTo($(this.$.port));
        template.clone().appendTo($(this.$.vertical));
        template.clone().appendTo($(this.$.starboard));

        var self = this;
        self.setVertical(1500);
        self.setPort(1500);
        self.setStarboard(1500);

      },
      ready: function() {
        var self = this;
      },
      setPowerLevel: function (level) {
        var self = this;
        console.log("Setting power level:", level);
        this.set("powerLevel", level);
        var portMaxElement = $(this.$.port).find('#maxThrottle rect');
        var verticalMaxElement = $(this.$.vertical).find('#maxThrottle rect');
        var starboardMaxElement = $(this.$.starboard).find('#maxThrottle rect');
        console.log(this.$.maxThrottle.querySelector('rect#leftThrottleRect'));

        var something = this.$.maxThrottle.querySelector('rect#leftThrottleRect');
        

        //815 is the design height of the throttle SVG element, 200 the min height of the throttle display at power level 1
        var height = level.map(0, 5, 0, 815);
        var y = 815 / 2 - height / 2;
        console.log(something.getAttribute("height"));
        something.setAttribute("height", height);
        //This will cause port vertical and starboard max throttles to change using css
        // portMaxElement.attr('height', height);
        // portMaxElement.attr('y', y);


        // verticalMaxElement.attr('height', height);
        // verticalMaxElement.attr('y', y);

        // starboardMaxElement.attr('height', height);
        // starboardMaxElement.attr('y', y);
        console.log(self.leftThrottleHeight);
        this.height = height;
      },
      setVertical: function (lift) {
        var element = $(this.$.vertical).find('#throttle');
        this.setElement(element, lift);
      },
      setPort: function (left) {
        var element = $(this.$.port).find('#throttle');
        this.setElement(element, left);
      },
      setStarboard: function (right) {
        var element = $(this.$.starboard).find('#throttle');
        this.setElement(element, right);
      },
      setElement: function (element, value) {
        
        // Grab the current maximum drawn throttle value
        var maxHeight = $(this.$.port).find('#maxThrottle rect').attr('height');

        //Zero point as reported by the throttle value passed in is 1500
        var height = maxHeight/2.0;
        if( value == 1500 )
        {
          height = 0;
        } 
        
        var y = 815 / 2 - height;
        if( value < 1500 )
        {
          y = 815 / 2;
        }

        element.attr('height', height);
        element.attr('y', y);
      }
    });
  </script>
</dom-module>
