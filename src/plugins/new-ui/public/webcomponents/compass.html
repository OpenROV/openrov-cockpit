<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../orov-behaviors/orov-behavior.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">

<dom-module id="orov-newui-compass">
  <style>
    #compass-container {
      width: 90%;
    }

    .center {
      left: 0;
      right: 0;
      margin-left: auto;
      margin-right: auto;
      float: none;
    }

    .notransition {
      -webkit-transition: none !important;
      -moz-transition: none !important;
      -o-transition: none !important;
      transition: none !important;
    }

    #indicator {
      /*Hardware acceleration*/
      translate3d(0,0,0);

      transform-origin: 472.5px 472.5px;
      transition-duration: 0.1s;
      transition-timing-function: ease-out;
    }

    #bearing {
      /*Hardware acceleration*/
      translate3d(0,0,0);

      transform-origin: 472.5px 472.5px;
      transition-duration: 0.1s;
      transition-timing-function: ease-out;
    }

    #heading {
      cursor: pointer;
    }

    #mode:hover {
      cursor: pointer;
    }

  </style>
  <template>
    <paper-tooltip for="mode" position="left" style="text-align:center; left:-150px" animation-delay="0">Make sure the IMU is mounted far away from power lines. Otherwise, it might not work as expected.</paper-tooltip>
    <div  id="compass-container" class="center">
      <svg id="svg3988" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 1280" version="1.2" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/">
        <metadata id="metadata4078">
          <rdf:RDF>
            <cc:Work rdf:about="">
              <dc:format>image/svg+xml</dc:format>
              <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
              <dc:title/>
            </cc:Work>
          </rdf:RDF>
        </metadata>
        <g id="g4986" transform="translate(170.040901,12.197624)">
          <g id="rose">
            <circle id="circle" stroke-width="10" d="m 832.5,472.5 c 0,198.82251 -161.17749,360 -360,360 -198.82251,0 -360,-161.17749 -360,-360 0,-198.82251 161.17749,-360 360,-360 198.82251,0 360,161.17749 360,360 z" cy="472.5" stroke$="{{ options.bezel }}" cx="472.5"
            r="360" fill="none" />
            <rect id="rect4935" y="96" width="10" x="467.5" height="30" fill$="{{ options.bezel }}" />
            <rect id="rect4937" transform="matrix(-1,0,0,-1,945,945)" fill$="{{ options.bezel }}" height="30" width="10" y="96" x="467.5" />
            <rect id="rect4943" transform="matrix(0,1,-1,0,945,0)" fill$="{{ options.bezel }}" height="30" width="10" y="96" x="467.5" />
            <rect id="rect4949" transform="matrix(0,-1,1,0,0,945)" fill$="{{ options.bezel }}" height="30" width="10" y="96" x="467.5" />
            <rect id="rect4951" transform="matrix(0.70710678,-0.70710678,0.70710678,0.70710678,-195.71591,472.5)" fill$="{{ options.bezel }}" height="30" width="10" y="96" x="467.5" />
            <rect id="rect4953" transform="matrix(-0.70710678,-0.70710678,0.70710678,-0.70710678,472.5,1140.7159)" fill$="{{ options.bezel }}" height="30" width="10" y="96" x="467.5" />
            <rect id="rect4955" transform="matrix(-0.70710678,0.70710678,-0.70710678,-0.70710678,1140.7159,472.5)" fill$="{{ options.bezel }}" height="30" width="10" y="96" x="467.5" />
            <rect id="rect4957" transform="matrix(0.70710678,0.70710678,-0.70710678,0.70710678,472.5,-195.71591)" fill$="{{ options.bezel }}" height="30" width="10" y="96" x="467.5" />
            <g id="compassIndicators" display$="{{ displayCompassIndicators(isCompass) }}" font-size="72px" font-family="Helvetica Neue,Helvetica,Arial,sans-serif" style="word-spacing:0;letter-spacing:0;" letter-spacing="0" word-spacing="0" font-weight="bold">
              <text id="indicator_n" fill$="{{ options.bezel }}" style="text-anchor:middle;text-align:center;" line-height="125%" y="90.702766" x="471.9191">{{__('N')}}</text>
              <text id="text4961" fill$="{{ options.bezel }}" style="text-anchor:middle;text-align:center;" transform="matrix(-1,0,0,-1,943.74133,945)" line-height="125%" y="80.803268" x="471.90582">{{__('S')}}</text>
              <text id="text4965" fill$="{{ options.bezel }}" style="text-anchor:middle;text-align:center;" transform="matrix(0,1,-1,0,0,0)" line-height="125%" y="-864.25293" x="471.84961">{{__('E')}}</text>
              <text id="text4967" fill$="{{ options.bezel }}" style="text-anchor:middle;text-align:center;" transform="matrix(0,-1,1,0,0,0)" line-height="125%" y="80.859489" x="-473.15039">{{__('W')}}</text>
              <text id="text4969" fill$="{{ options.bezel }}" style="text-anchor:middle;text-align:center;" transform="matrix(0.70710678,-0.70710678,0.70710678,0.70710678,0,0)" line-height="125%" font-size="72px" y="278.64713" x="-4.2105641">{{__('NW')}}</text>
              <text id="text4971" fill$="{{ options.bezel }}" style="text-anchor:middle;text-align:center;" transform="matrix(-0.70710678,-0.70710678,0.70710678,-0.70710678,0,0)" line-height="125%" font-size="72px" y="-393.78027" x="-670.0802">{{__('SW')}}</text>
              <text id="text4973" fill$="{{ options.bezel }}" style="text-anchor:middle;text-align:center;" transform="matrix(-0.70710678,0.70710678,-0.70710678,-0.70710678,0,0)" line-height="125%" font-size="72px" y="-1060.8452" x="1.1167512">{{__('SE')}}</text>
              <text id="text4975" fill$="{{ options.bezel }}" style="text-anchor:middle;text-align:center;" transform="matrix(0.70710678,0.70710678,-0.70710678,0.70710678,0,0)" line-height="125%" font-size="72px" y="-391.12482" x="667.26764">{{__('NE')}}</text>
            </g>
            <g id="gyroIndicators" display$="{{ displayGyroIndicators(isCompass) }}" font-size="72px" font-family="Helvetica Neue,Helvetica,Arial,sans-serif" style="word-spacing:0;letter-spacing:0;" letter-spacing="0" word-spacing="0" font-weight="bold">
              <text id="indicator_n" fill$="{{ options.bezel }}" style="text-anchor:middle;text-align:center;" line-height="125%" y="60.702766" x="471.9191">{{__('0')}}</text>
              <text id="text4961" fill$="{{ options.bezel }}" style="text-anchor:middle;text-align:center;" transform="matrix(1,0,0,1,0,850)" line-height="125%" y="80.803268" x="471.90582">{{__('-180+')}}</text>
              <text id="text4965" fill$="{{ options.bezel }}" style="text-anchor:middle;text-align:center;" transform="matrix(1,0,0,1,460,-38)" line-height="125%" y="530" x="460">{{__('+90')}}</text>
              <text id="text4967" fill$="{{ options.bezel }}" style="text-anchor:middle;text-align:center;" transform="matrix(1,0,0,1,-425,-35)" line-height="125%" y="530" x="460">{{__('-90')}}</text>
              <text id="text4969" fill$="{{ options.bezel }}" style="text-anchor:middle;text-align:center;" transform="matrix(1,0,0,1,-320,300)" line-height="125%" font-size="72px" y="530" x="460">{{__('-135')}}</text>
              <text id="text4971" fill$="{{ options.bezel }}" style="text-anchor:middle;text-align:center;" transform="matrix(1,0,0,1,-325,-350)" line-height="125%" font-size="72px" y="530" x="460">{{__('-45')}}</text>
              <text id="text4973" fill$="{{ options.bezel }}" style="text-anchor:middle;text-align:center;" transform="matrix(1,0,0,1,325,-350)" line-height="125%" font-size="72px" y="530" x="460">{{__('+45')}}</text>
              <text id="text4975" fill$="{{ options.bezel }}" style="text-anchor:middle;text-align:center;" transform="matrix(1,0,0,1,320,300)" line-height="125%" font-size="72px" y="530" x="460">{{__('+135')}}</text>
            </g>
          </g>

          <text id="lock" fill$="{{ options.bezel }}" style="letter-spacing:0;text-anchor:middle;word-spacing:0;text-align:center;" font-family="Helvetica Neue,Helvetica,Arial,sans-serif" font-size="120px" letter-spacing="0" line-height="100%" word-spacing="0" y="280" x="460.67117" title="Heading hold target">{{__('LK')}}</text>

          <text id="heading" fill$="{{ options.headingFill }}" stroke$="{{ options.bezel }}" stroke-width$="{{ options.headingStrokeWidth }}" style="letter-spacing:0;text-anchor:middle;word-spacing:0;text-align:center;" font-family="Helvetica Neue,Helvetica,Arial,sans-serif" font-size="250px" letter-spacing="0"
          line-height="125%" word-spacing="0" y="530" x="460.67117" font-weight="bold">{{heading}}</text>
          
          <text id="target" fill$="{{ options.bezel }}" style="letter-spacing:0;text-anchor:middle;word-spacing:0;text-align:center;" font-family="Helvetica Neue,Helvetica,Arial,sans-serif" font-size="150px" letter-spacing="0" line-height="100%" word-spacing="0" y="680" x="460.67117" font-weight="bold"
          title="Heading hold target">{{target}}</text>

          <text id="mode" fill$="{{ options.modeFill }}" stroke$="{{ options.bezel }}" stroke-width$="{{ options.headingStrokeWidth }}" style="letter-spacing:0;text-anchor:middle;word-spacing:0;text-align:center;" font-family="Helvetica Neue,Helvetica,Arial,sans-serif" font-size="200px" letter-spacing="0"
          line-height="125%" word-spacing="0" y="1206" x="460.67117" font-weight="bold" tabindex="0">{{ compassMode(isCompass) }}</text>
          
          <g id="indicator">
            <path fill$="{{ options.indicator }}" d="m 471.41747,-25.529456 c 35.08805,139.334496 35.04692,139.182386 35.04692,139.182386 l -69.01546,0 z" style="fill-opacity:1;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"/>
          </g>
          <g id="bearing">
            <path fill$="{{ options.bezel }}" style="fill-opacity:1;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" d="m 472.79747,253.34433 c -35.08391,-139.0359 -35.0428,-138.88412 -35.0428,-138.88412 l 69.00736,0 z" />
          </g>
        </g>
      </svg>
    </div>

    
  </template>
  
  <script>
      var lastData = null;
      var newData = null;

      var mapTo = function (value, in_min, in_max, out_min, out_max) {
        return (value - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
      };

      var bearingAngle = { angle: null };
      var indicatorAngle = { angle: null };

      function nearestNumber(x, a, b) {
        var aDelta = a - x;
        if(aDelta < 0)
        {
          aDelta = -aDelta;
        }

        var bDelta = b - x;
        if(bDelta < 0)
        {
          bDelta = -bDelta;
        }

        if(aDelta < bDelta)
        {
          return a;
        }
        return b;
      }

      function rotateElement(element, currentPos, newPos) {
        currentPos.angle = currentPos.angle || 0; // if rot undefined or 0, make 0, else rot

        var diff = 360 - newPos;
        var dp = newPos + 360;
        var dm = newPos - 360;

        //Way to visually surpress the jumps between angles on the compass
        var posDelta = (currentPos.angle - newPos);
        var absPosDelta = Math.abs(currentPos.angle) - Math.abs(newPos);

        var check1 = (posDelta >= 350 && absPosDelta <= 0)
        var check2 = (posDelta <= -360 && absPosDelta >= 355)
        if(check1 || check2)
        {
          element.classList.add('notransition');
        }
        else
        {
          element.classList.remove('notransition');
        }

        //Apply the rotation element
        if(nearestNumber(currentPos.angle, newPos, dp) == dp)
        {
          element.style.transform = ("rotate( " + dp + "deg )");
          currentPos.angle = dp;
        }
        else if(nearestNumber(currentPos.angle, newPos, dm) == dm)
        {
          element.style.transform = ("rotate( " + dm + "deg )");
          currentPos.angle = dm;
        }
        else
        {
          element.style.transform = ("rotate( " + newPos + "deg )");
          currentPos.angle = newPos;
        }
      }



      Polymer({
        is: 'orov-newui-compass',
        properties: {
          bearing: {
            type: String,
            value: function(){return undefined;}
          },
          heading: {
            type: String,
            value: function(){return undefined;}
          },
          headingLock: {
            type: Boolean,
            value: function(){return false;}
          },
          isCompass: {
            type: Boolean,
            value: function(){return false;}
          },
          mode: {
            type: String,
            value: function(){return "Gyro";}
          },
          options: {
            type: Object,
            value: {
                indicator: 'white',
                bezel: 'white',
                bearing: 'white',
                background: 'black',
                headingFill: 'white',
                modeFill: 'white',
                // will be set to options.bezel
                headingStrokeWidth: 0,
                headingStrokeWidthTargetHold: 15
              }
          },
          target: {
            type: Number,
            value: function(){return 0;}
          }
        },
        listeners: {
          'mode.tap': 'toggleMode',
          'heading.tap': 'toggleHeadingLock'
        },
        toggleMode: function(e) {
          if (this.eventEmitter){
						var newState  = {imuMode:this.isCompass? "gyro" : "compass"}
            this.eventEmitter.emit('plugin.navigationData.setState',newState );
					}
        },
        toggleHeadingLock: function(e) {
          this.$.headingLock = !this.$.headingLock;
        },

        rotateElement(element, currentPos, newPos) {
          currentPos.angle = currentPos.angle || 0; // if rot undefined or 0, make 0, else rot
          


          var diff = 360 - newPos;
          var dp = newPos + 360;
          var dm = newPos - 360;

          if(180 - Math.abs(currentPos.angle) <= 5 )
          {
            element.classList.add('notransition');
          }
          else
          {
            element.classList.remove('notransition');

          }

          if(nearestNumber(currentPos.angle, newPos, dp) == dp)
          {
            element.style.transform = ("rotate( " + dp + "deg )");
            currentPos.angle = dp;
          }
          else if(nearestNumber(currentPos.angle, newPos, dm) == dm)
          {
            element.style.transform = ("rotate( " + dm + "deg )");
            currentPos.angle = dm;
          }
          else
          {
            element.style.transform = ("rotate( " + newPos + "deg )");
            currentPos.angle = newPos;
          }
        },
        

        behaviors: [namespace('behaviors').oROVStandard],
        registerEmitterHandlers: function(emitter) {
          var self = this;
          emitter.withHistory.on('plugin.rovpilot.headingHold.state', function(state) {

            if (state.enabled)
            {
              self.setBearing(parseFloat(state.targetHeading).toFixed(0));
              self.options.headingFill = 'none';
              self.options.headingStrokeWidth = self.options.headingStrokeWidthTargetHold;
            } 
            else 
            {
              self.setBearing(undefined);
              self.options.headingFill = self.options.bezel;
              self.options.headingStrokeWidth = 0;
            }
          });
          emitter.on('plugin.navigationData.data', function(data) {
            newData = data;
          }); 

          emitter.withHistory.on('plugin.navigationData.state', function(state){
            if (state.imuMode){
              switch(state.imuMode){
                case "compass":
                  self.set("isCompass",true);
                break;
                case "gyro":
                  self.set("isCompass",false);
                break;
                default:
                  throw new Error("Unknown imu_mode: ",mode);
              }
            }
          })
        },
        attached: function() {
          var self = this;

          self.options.headingFill = self.options.bezel;

          this.setHeading(this.heading);
          this.setBearing(this.bearing);
          this._dataThrottleInterval = setInterval(function(){
            if (newData == lastData) return;
            lastData=newData;
            self.setHeading(parseFloat(newData.heading).toFixed(0));          
          },100);                 
        },
        detached: function(){
          clearInterval(this._dataThrottleInterval);
        },
        compassMode: function() {
          if(this.isCompass) {
            return "Compass";
          }
          else {
            return "Gyro";
          }
        },
        displayCompassIndicators: function(isCompass) {
          if(this.isCompass) {
            return "block";
          }
          else {
            return "none";
          }
        },
        displayGyroIndicators: function(isCompass) {
          if(this.isCompass) {
            return "none";
          }
          else {
            return "block";
          }
        },
        format: function(newOptions) {
          this.set('options.indicator', newOptions.indicator ? newOptions.indicator : this.options.indicator);
          this.set('options.bezel', newOptions.bezel ? newOptions.bezel : this.options.bezel);
          this.set('options.bearing', newOptions.bearing ? newOptions.bearing : this.options.bearing);
          this.set('options.background', newOptions.background ? newOptions.background : this.options.background);
        },
        setHeading: function(value) {
          var self = this;
          self.heading = value;     

          rotateElement(this.$.indicator, indicatorAngle, value);

          if(!this.target) 
          {
            var bearing = $(this.$.bearing);
            rotateElement(this.$.bearing, bearingAngle, value);
          }
        },
        setBearing: function(value) {
          var self = this;
          self.bearing = value;

          if(value) 
          {
            this.target = this.bearing;

            rotateElement(this.$.bearing, bearingAngle, value);

            this.$.target.style.fillOpacity="100.0";
            this.$.lock.style.fillOpacity="100.0";

          } 
          else 
          {

            this.$.target.style.fillOpacity="0.0";
            this.$.lock.style.fillOpacity="0.0";
            
            rotateElement(this.$.bearing, bearingAngle, this.heading);

            this.target = undefined;
          }
        }
      });
  </script>
</dom-module>