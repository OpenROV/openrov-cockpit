

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../orov-behaviors/orov-behavior.html">

<dom-module id="orov-map">
	<style>	
		:host 
		{
			display: block;
			position: absolute;
			left: 0;
			top: 0;
			width: 100%;
			height: 100vh;;
		}

		#map
		{
			position: absolute;
			left: 0;
			top: 0;
			width: 100%;
			height: 100vh;
		}  
		
		#marker {
			width: 10px;
			height: 10px;
			border: 1px solid #B00;
			border-radius: 10px;
			background-color: #F00;
			opacity: 0.5;
		}
	  
		#ship {
			width: 10px;
			height: 10px;
			border: 1px solid #0BB;
			border-radius: 10px;
			background-color: #0FF;
			opacity: 0.5;
		}
	</style>

	<template>
		<link rel="stylesheet" type="text/css" href="../openlayers/ol.css" />
		
		<div id="map" class="map"></div>
		
		<div style="display: none;">
			<div id="marker" title="Marker"></div>
			<div id="ship" title="Ship"></div>
		</div>
	</template>

	<script src="../openlayers/ol.js"></script>

	<script>
		Polymer(
		{
			is: 'orov-map',
			
			properties: 
			{
				currentCenter: Array,
				currentView: ol.View,
				olmap: ol.Map,
				layer: Object,
				marker: ol.Overlay,
				ship: ol.Overlay,
				
				longitude:
				{
					type: Number,
					value:-120.0,
					notify: true,
					observer: '_updateLongitude'
				},
				
				latitude: 
				{
					type: Number,
					value: 29.0,
					notify: true,
					observer: '_updateLatitude'
				},
			
				elemReady: Boolean,
			},
			
			listeners:
			{
				"gps": "UpdateMarker" 
			},

			behaviors: [namespace('behaviors').oROVStandard],
			
			ready: function()
			{				
			},

			registerEmitterHanlders: function(emitter) 
			{
				var self = this;

				emitter.withHistory.on( "plugin.gps.data", function(data) 
				{
					console.log( "Got boat position: " + data.lat + "," + data.lon );
					self.fire( "gps", data );
				});
			},

			attached: function()
			{
				this.async(function()
				{
					this.initialConfig(); // Create your ol.Map here
					this.elemReady = true;
					this.setCenter(this.latitude,this.longitude);
					
					this.olmap.updateSize();
					
					console.log('openlayer-map ready');
					
					setTimeout( function()
					{
						window.dispatchEvent( new Event( "resize" ) );
					}, 1000 );
				});
			},
			
			initialConfig: function()
			{
				var self = this;
				console.log('initial config for the map...');

				this.currentView = new ol.View(
				{
					zoom: 14
				});
				
				var pos = ol.proj.fromLonLat([-119.9542667, 39.0916667]);

				// Vienna marker
				this.marker = new ol.Overlay({
					position: pos,
					positioning: 'center-center',
					element: this.$.marker,
					stopEvent: false
				});

				var shipPos = ol.proj.fromLonLat([-119.9542667, 39.0916667]);

				// Vienna marker
				this.ship = new ol.Overlay({
					position: shipPos,
					positioning: 'center-center',
					element: this.$.ship,
					stopEvent: false
				});

				var source = new ol.source.OSM();
				this.layer =  new ol.layer.Tile();
				
				this.layer.setSource(source); 
				
				this.olmap = new ol.Map(
				{
					layers: [this.layer],
					target: this.$.map,
					controls: ol.control.defaults(
					{
						attributionOptions: /** @type {olx.control.AttributionOptions} */ (
						{
							collapsible: false
						})
					}),
					view: this.currentView
				});
				
				this.historyLines = new ol.geom.LineString([]);


				this.layerLines = new ol.layer.Vector({
					source: new ol.source.Vector({
						features: [new ol.Feature({
							geometry: self.historyLines
						})]
					}),
					style: new ol.style.Style({
						stroke: new ol.style.Stroke({
							width: 0.5,
							color: '#000000',
						})
					})
				});

				this.olmap.addLayer( this.layerLines );

				this.olmap.addOverlay( this.marker );
				this.olmap.addOverlay( this.ship );
			},


			_updateLatitude: function(newValue, oldValue)
			{
					if(this.elemReady)
					{
						console.log('update latitude from '+oldValue+' to '+newValue);
						this.setCenter(newValue, this.longitude);
					}
					else
					{
						console.log('_updateLatitude: waiting element to be ready');
					}
			},

			_updateLongitude: function(newValue, oldValue)
			{
				if(this.elemReady)
				{
					console.log('update longitude from '+oldValue+' to '+newValue);
					this.setCenter(this.latitude, newValue);
				}
				else
				{
					console.log('_updateLatitude: waiting element to be ready');
				}
			},

			setCenter: function(latitude, longitude)
			{

				var center = [longitude, latitude];
				this.currentCenter = ol.proj.fromLonLat(center);
				console.log('update center of the map with latitude = '+latitude+' and longitude = '+longitude);
				this.currentView.centerOn(this.currentCenter,[400,400], [0,0]);
			},
			
			UpdateMarker: function( data )
			{
				var pos = ol.proj.fromLonLat([ data.detail.lon, data.detail.lat ]);
				
				if( this.marker != undefined )
				{
					this.marker.setPosition( pos );
					this.historyLines.appendCoordinate(pos);
				}
			}
		} );
	</script>
</dom-module>

